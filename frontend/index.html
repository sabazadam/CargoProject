<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Cargo Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .indicator-red { color: #ef4444; /* red-500 */ }
        .indicator-orange { color: #f97316; /* orange-500 */ }
        .indicator-green { color: #22c55e; /* green-500 */ }
        .truck-card, .box-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .truck-card:hover, .box-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        .truck-card.selected {
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.4);
        }
        .quantity-input {
            width: 80px; /* Wider input field */
            text-align: center;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem;
        }
        /* Hide number input spinners on Chrome, Safari, Edge */
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Hide number input spinners on Firefox */
        .quantity-input[type=number] {
            -moz-appearance: textfield;
        }

        /* Modal Styles */
        .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-container {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .modal-hidden { /* Combined hidden state for overlay and container */
            opacity: 0;
            pointer-events: none; /* Make it non-interactive when hidden */
        }
        .modal-hidden .modal-overlay { /* Ensure overlay also fades out */
            opacity: 0;
        }
        .modal-hidden .modal-container {
            opacity: 0;
            transform: scale(0.95);
        }
        #sceneContainer canvas {
            display: block; /* Prevents extra space below canvas */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen p-4 md:p-6">

    <div class="container mx-auto max-w-7xl bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
        <header class="mb-8 text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-600">Interactive Cargo Planner</h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Select Truck</h2>
                    <div id="truckSelectionArea" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        </div>
                </div>

                <div>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Configure Box Quantities</h2>
                    <div id="boxConfigurationArea" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="p-5 bg-gray-50 rounded-lg shadow sticky top-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">Actions</h2>
                    <button id="findBestFitBtn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-md shadow-md transition duration-150 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed mb-3">
                        <i class="fas fa-random mr-2"></i>Volumetric Fit (Random)
                    </button>
                    <button id="view3DLoadBtn" class="w-full py-3 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-md shadow-md transition duration-150 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:ring-opacity-50 mb-3">
                        <i class="fas fa-cube mr-2"></i>Calculate & View 3D Load
                    </button>
                    <button id="sendCargoBtn" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-md shadow-md transition duration-150 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed mb-3">
                        <i class="fas fa-truck-ramp-box mr-2"></i>Send Cargo
                    </button>
                    <button id="addBoxesBtn" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md shadow-md transition duration-150 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-50 mb-3">
                        <i class="fas fa-plus-square mr-2"></i>Add Boxes to Stock
                    </button>
                    <button id="resetSelectionsBtn" class="w-full py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-md shadow-md transition duration-150 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                        <i class="fas fa-undo mr-2"></i>Reset Selections
                    </button>
                    <p id="actionMessage" class="text-xs text-center mt-3 h-4 text-red-500"></p>

                    <div class="mt-6">
                        <h2 class="text-xl font-semibold text-gray-700 mb-3 border-b pb-2">Truck Status</h2>
                        <div id="truckStatusInfo" class="text-sm space-y-2 text-gray-600">
                            <p>Selected Truck: <span id="selectedTruckName" class="font-medium text-gray-900">-</span></p>
                            <p>Total Truck Volume: <span id="truckTotalVolume" class="font-medium text-gray-900">-</span></p>
                            <div class="w-full bg-gray-200 rounded-full h-6 mb-1 shadow-inner overflow-hidden">
                                <div id="truckLoadProgress" class="bg-green-500 h-6 text-xs font-medium text-blue-100 text-center p-1 leading-none rounded-full transition-all duration-300 ease-out" style="width: 0%;">
                                    0%
                                </div>
                            </div>
                            <p>Loaded Volume: <span id="truckLoadedVolume" class="font-medium text-gray-900">-</span></p>
                            <p>Remaining Volume: <span id="truckRemainingVolume" class="font-medium text-gray-900">-</span></p>
                            <p id="truckStatusMessage" class="font-semibold h-5"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal3D" class="fixed inset-0 z-50 overflow-y-auto modal-hidden flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black modal-overlay"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl lg:max-w-4xl mx-auto rounded-lg shadow-xl z-50 overflow-y-auto">
            <div class="p-4 md:p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <p class="text-2xl font-semibold text-gray-700">3D Load Preview</p>
                    <button id="closeModal3DBtn" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times fa-2x"></i>
                    </button>
                </div>
                <div id="sceneContainer" class="w-full h-[400px] md:h-[500px] lg:h-[600px] bg-gray-200 rounded relative overflow-hidden">
                    <p id="loading3DMessage" class="absolute inset-0 flex items-center justify-center text-gray-500">Loading 3D Scene...</p>
                </div>
                 <p class="text-xs text-gray-500 mt-2 text-center">Use mouse to orbit, scroll to zoom, right-click to pan.</p>
            </div>
        </div>
    </div>

    <div id="addBoxesModal" class="fixed inset-0 z-50 overflow-y-auto modal-hidden flex items-center justify-center p-4">
        <div class="fixed inset-0 bg-black modal-overlay" id="addBoxesOverlay"></div>
        <div class="modal-container bg-white w-11/12 max-w-md mx-auto rounded-lg shadow-xl z-50">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <p class="text-2xl font-semibold text-gray-700">Add Boxes to Stock</p>
                    <button id="closeAddBoxesModalBtn" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times fa-2x"></i>
                    </button>
                </div>
                <div id="addBoxesContainer" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button id="cancelAddBoxesBtn" class="py-2 px-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-md shadow-md transition">Cancel</button>
                    <button id="confirmAddBoxesBtn" class="py-2 px-6 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md shadow-md transition">Add to Stock</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Data Structures ---
        let BOX_TYPES_DATA = {};
        let INVENTORY_DATA = {};

        const TRUCK_TYPES_DATA = {
            "pickup": { name: "Pickup Truck", length: 100, width: 50, height: 50, volume: 250000, icon: "fa-truck-pickup" },
            "van": { name: "Cargo Van", length: 200, width: 100, height: 100, volume: 2000000, icon: "fa-truck-moving" },
            "semi": { name: "Semi Trailer", length: 500, width: 150, height: 150, volume: 11250000, icon: "fa-truck" }
        };

        // --- State Variables ---
        let selectedTruckKey = null;
        let selectedBoxCounts = {};

        // --- DOM Elements ---
        const truckSelectionArea = document.getElementById('truckSelectionArea');
        const boxConfigurationArea = document.getElementById('boxConfigurationArea');
        const findBestFitBtn = document.getElementById('findBestFitBtn');
        const resetSelectionsBtn = document.getElementById('resetSelectionsBtn');
        const actionMessageEl = document.getElementById('actionMessage');
        const sendCargoBtn = document.getElementById('sendCargoBtn');
        const addBoxesBtn = document.getElementById('addBoxesBtn');
        const selectedTruckNameEl = document.getElementById('selectedTruckName');
        const truckTotalVolumeEl = document.getElementById('truckTotalVolume');
        const truckLoadProgressEl = document.getElementById('truckLoadProgress');
        const truckLoadedVolumeEl = document.getElementById('truckLoadedVolume');
        const truckRemainingVolumeEl = document.getElementById('truckRemainingVolume');
        const truckStatusMessageEl = document.getElementById('truckStatusMessage');

        // 3D Modal Elements
        const view3DLoadBtn = document.getElementById('view3DLoadBtn');
        const modal3D = document.getElementById('modal3D');
        const closeModal3DBtn = document.getElementById('closeModal3DBtn');
        const sceneContainer = document.getElementById('sceneContainer');
        const loading3DMessageEl = document.getElementById('loading3DMessage');

        // Add Boxes Modal Elements
        const addBoxesModal = document.getElementById('addBoxesModal');
        const closeAddBoxesModalBtn = document.getElementById('closeAddBoxesModalBtn');
        const addBoxesOverlay = document.getElementById('addBoxesOverlay');
        const cancelAddBoxesBtn = document.getElementById('cancelAddBoxesBtn');
        const confirmAddBoxesBtn = document.getElementById('confirmAddBoxesBtn');
        const addBoxesContainer = document.getElementById('addBoxesContainer');


        // --- Initialization ---
        async function initializeApp() {
            await fetchInventory();
            renderTrucks();
            renderBoxes();
            resetSelectedBoxCounts();
            updateTruckStatusUI();

            // Main Action Listeners
            findBestFitBtn.addEventListener('click', handleFindBestFit);
            resetSelectionsBtn.addEventListener('click', handleResetSelections);
            sendCargoBtn.addEventListener('click', handleSendCargo);

            // 3D Modal Listeners
            view3DLoadBtn.addEventListener('click', handleView3DLoad);
            closeModal3DBtn.addEventListener('click', () => {
                modal3D.classList.add('modal-hidden');
                cleanup3DScene();
            });

            // Add Boxes Modal Listeners
            addBoxesBtn.addEventListener('click', handleShowAddBoxesModal);
            closeAddBoxesModalBtn.addEventListener('click', () => addBoxesModal.classList.add('modal-hidden'));
            addBoxesOverlay.addEventListener('click', () => addBoxesModal.classList.add('modal-hidden'));
            cancelAddBoxesBtn.addEventListener('click', () => addBoxesModal.classList.add('modal-hidden'));
            confirmAddBoxesBtn.addEventListener('click', handleConfirmAddBoxes);


            updateActionButtonsState();
        }

        async function fetchInventory() {
            try {
                const response = await fetch('http://127.0.0.1:5500/inventory');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                BOX_TYPES_DATA = {};
                INVENTORY_DATA = {};
                for (const key in data) {
                    BOX_TYPES_DATA[key] = {
                        name: data[key].name,
                        length: data[key].length,
                        width: data[key].width,
                        height: data[key].height,
                        volume: data[key].volume,
                        icon: data[key].icon,
                        color: parseInt(data[key].color, 16)
                    };
                    INVENTORY_DATA[key] = data[key].stock;
                }
                console.log("Inventory fetched and sorted by volume:", Object.keys(BOX_TYPES_DATA));
            } catch (error) {
                console.error('Error fetching inventory:', error);
                actionMessageEl.textContent = "Error fetching inventory from backend.";
                actionMessageEl.className = "text-xs text-center mt-3 h-4 text-red-500";
            }
        }

        // --- Rendering Functions ---
        function renderTrucks() {
            truckSelectionArea.innerHTML = '';
            Object.keys(TRUCK_TYPES_DATA).forEach(key => {
                const truck = TRUCK_TYPES_DATA[key];
                const card = document.createElement('div');
                card.className = `truck-card p-4 bg-white border-2 border-gray-200 rounded-lg shadow-md cursor-pointer flex flex-col items-center justify-center text-center ${selectedTruckKey === key ? 'selected' : ''}`;
                card.dataset.truckKey = key;
                card.innerHTML = `
                    <i class="fas ${truck.icon} fa-3x mb-2 text-indigo-500"></i>
                    <h3 class="font-semibold text-lg">${truck.name}</h3>
                    <p class="text-xs text-gray-500">Vol: ${truck.volume.toLocaleString()}</p>
                `;
                card.addEventListener('click', () => handleTruckSelection(key));
                truckSelectionArea.appendChild(card);
            });
        }

        function renderBoxes() {
            boxConfigurationArea.innerHTML = '';
            if (Object.keys(BOX_TYPES_DATA).length === 0) {
                boxConfigurationArea.innerHTML = '<p class="text-center text-gray-500">Loading box data...</p>';
                return;
            }
            // The backend now sends data sorted by volume, so we just iterate
            Object.keys(BOX_TYPES_DATA).forEach(key => {
                const box = BOX_TYPES_DATA[key];
                const card = document.createElement('div');
                card.className = 'box-card p-4 bg-white border border-gray-200 rounded-lg shadow flex flex-col items-center text-center';
                card.innerHTML = `
                    <i class="fas ${box.icon} fa-2x mb-2 text-green-500"></i>
                    <h4 class="font-semibold">${box.name}</h4>
                    <p class="text-xs text-gray-500">Vol: ${box.volume.toLocaleString()}</p>
                    <p class="text-xs text-gray-500">Stock: <span id="stock-${key}">${INVENTORY_DATA[key] || 0}</span></p>
                    <div class="flex items-center justify-center mt-3">
                        <button class="quantity-btn p-2 bg-gray-200 hover:bg-gray-300 rounded-l-md" data-box-key="${key}" data-change="-1">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="count-${key}" value="${selectedBoxCounts[key] || 0}" min="0" data-box-key="${key}" class="quantity-input" />
                        <button class="quantity-btn p-2 bg-gray-200 hover:bg-gray-300 rounded-r-md" data-box-key="${key}" data-change="1">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;
                boxConfigurationArea.appendChild(card);
            });

            boxConfigurationArea.addEventListener('input', handleBoxQuantityChange);
            boxConfigurationArea.addEventListener('click', handleQuantityButtonClick);
        }

        // --- UI Update Functions ---
        function updateTruckStatusUI() {
            if (selectedTruckKey) {
                const truck = TRUCK_TYPES_DATA[selectedTruckKey];
                selectedTruckNameEl.textContent = truck.name;
                truckTotalVolumeEl.textContent = truck.volume.toLocaleString();

                let currentLoadedVolume = 0;
                Object.keys(selectedBoxCounts).forEach(boxKey => {
                    if (BOX_TYPES_DATA[boxKey]) {
                        currentLoadedVolume += (selectedBoxCounts[boxKey] || 0) * BOX_TYPES_DATA[boxKey].volume;
                    }
                });

                const remainingVolume = truck.volume - currentLoadedVolume;
                truckLoadedVolumeEl.textContent = currentLoadedVolume.toLocaleString();
                truckRemainingVolumeEl.textContent = remainingVolume.toLocaleString();

                const loadPercentage = truck.volume > 0 ? (currentLoadedVolume / truck.volume) * 100 : 0;
                truckLoadProgressEl.style.width = `${Math.min(100, loadPercentage).toFixed(1)}%`;
                truckLoadProgressEl.textContent = `${Math.min(100, loadPercentage).toFixed(1)}% Full`;
            } else {
                selectedTruckNameEl.textContent = "-";
                truckTotalVolumeEl.textContent = "-";
                truckLoadedVolumeEl.textContent = "-";
                truckRemainingVolumeEl.textContent = "-";
                truckLoadProgressEl.style.width = "0%";
                truckLoadProgressEl.textContent = "0%";
                truckStatusMessageEl.textContent = "Select a truck.";
            }
            updateActionButtonsState();
        }

        function updateBoxCountDisplay(boxKey) {
            const countInput = document.getElementById(`count-${boxKey}`);
            if (countInput) countInput.value = selectedBoxCounts[boxKey] || 0;
            const stockSpan = document.getElementById(`stock-${boxKey}`);
            if (stockSpan) stockSpan.textContent = INVENTORY_DATA[boxKey] || 0;
        }

        function updateAllBoxCountDisplays() {
            Object.keys(BOX_TYPES_DATA).forEach(key => updateBoxCountDisplay(key));
        }

        function updateActionButtonsState() {
            findBestFitBtn.disabled = !selectedTruckKey;
            view3DLoadBtn.disabled = !selectedTruckKey;
            const hasBoxesSelected = Object.values(selectedBoxCounts).some(count => count > 0);
            sendCargoBtn.disabled = !selectedTruckKey || !hasBoxesSelected;
        }

        // --- Event Handlers & Logic ---
        function handleTruckSelection(key) {
            selectedTruckKey = key;
            const truckCards = truckSelectionArea.querySelectorAll('.truck-card');
            truckCards.forEach(card => card.classList.toggle('selected', card.dataset.truckKey === key));
            updateTruckStatusUI();
        }

        function resetSelectedBoxCounts() {
             Object.keys(BOX_TYPES_DATA).forEach(key => selectedBoxCounts[key] = 0);
        }

        function handleBoxQuantityChange(event) {
            const input = event.target;
            const boxKey = input.dataset.boxKey;
            if (!boxKey || !BOX_TYPES_DATA[boxKey]) return;

            actionMessageEl.textContent = "";
            if (!selectedTruckKey) {
                actionMessageEl.textContent = "Please select a truck first!";
                input.value = 0;
                setTimeout(() => actionMessageEl.textContent = "", 3000);
                return;
            }

            let value = parseInt(input.value, 10);
            if (isNaN(value) || value < 0) value = 0;
            if (value > INVENTORY_DATA[boxKey]) {
                value = INVENTORY_DATA[boxKey];
                actionMessageEl.textContent = `Only ${INVENTORY_DATA[boxKey]} of ${BOX_TYPES_DATA[boxKey].name} available.`;
                actionMessageEl.className = "text-xs text-center mt-3 h-4 text-orange-500";
                setTimeout(() => actionMessageEl.textContent = "", 3000);
            }

            input.value = value;
            selectedBoxCounts[boxKey] = value;
            updateTruckStatusUI();
        }

        function handleQuantityButtonClick(event) {
            const button = event.target.closest('.quantity-btn');
            if (!button) return;

            const boxKey = button.dataset.boxKey;
            const change = parseInt(button.dataset.change, 10);
            const input = document.getElementById(`count-${boxKey}`);
            if (!input) return;

            let currentValue = parseInt(input.value, 10) || 0;
            let newValue = currentValue + change;
            if (newValue < 0) newValue = 0;
            if (newValue > INVENTORY_DATA[boxKey]) {
                newValue = INVENTORY_DATA[boxKey];
                actionMessageEl.textContent = `Only ${INVENTORY_DATA[boxKey]} of ${BOX_TYPES_DATA[boxKey].name} available.`;
                actionMessageEl.className = "text-xs text-center mt-3 h-4 text-orange-500";
                setTimeout(() => actionMessageEl.textContent = "", 3000);
            }

            input.value = newValue;
            selectedBoxCounts[boxKey] = newValue;
            updateTruckStatusUI();
            actionMessageEl.textContent = "";
        }


        async function handleResetSelections() {
            resetSelectedBoxCounts();
            updateAllBoxCountDisplays();
            updateTruckStatusUI();
            actionMessageEl.textContent = "Selections have been reset.";
            actionMessageEl.className = "text-xs text-center mt-3 h-4 text-green-500";
            setTimeout(() => actionMessageEl.textContent = "", 3000);
            cleanup3DScene();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function handleFindBestFit() {
            if (!selectedTruckKey) return;
             resetSelectedBoxCounts();
             const truckVolume = TRUCK_TYPES_DATA[selectedTruckKey].volume;
             let remainingVolume = truckVolume;

             const availableBoxKeys = Object.keys(BOX_TYPES_DATA).filter(key => INVENTORY_DATA[key] > 0);
             shuffleArray(availableBoxKeys); // Randomize the order of boxes to try

             for(const key of availableBoxKeys) {
                 const box = BOX_TYPES_DATA[key];
                 const inventory = INVENTORY_DATA[key];
                 if(box.volume > 0) {
                     let numToFit = Math.min(inventory, Math.floor(remainingVolume / box.volume));
                     selectedBoxCounts[key] = numToFit;
                     remainingVolume -= numToFit * box.volume;
                 }
             }
             updateAllBoxCountDisplays();
             updateTruckStatusUI();
             actionMessageEl.textContent = "New random volumetric fit calculated!";
             actionMessageEl.className = "text-xs text-center mt-3 h-4 text-indigo-600";
             setTimeout(() => actionMessageEl.textContent = "", 4000);
        }

        async function updateInventoryBatchBackend(updates) {
             try {
                const response = await fetch('http://127.0.0.1:5500/inventory/update_batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ updates: updates }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                return true;
            } catch (error) {
                console.error('Error updating inventory:', error);
                actionMessageEl.textContent = `Update Error: ${error.message}`;
                actionMessageEl.className = "text-xs text-center mt-3 h-4 text-red-500";
                return false;
            }
        }

        async function handleSendCargo() {
            if (!selectedTruckKey) return;

            let updates = [];
            let totalBoxesSent = 0;
            Object.keys(selectedBoxCounts).forEach(boxKey => {
                const count = selectedBoxCounts[boxKey];
                if (count > 0) {
                    updates.push({ box_key: boxKey, change_amount: -count });
                    totalBoxesSent += count;
                }
            });

            if (totalBoxesSent === 0) {
                actionMessageEl.textContent = "No boxes selected to send.";
                actionMessageEl.className = "text-xs text-center mt-3 h-4 text-orange-500";
                setTimeout(() => actionMessageEl.textContent = "", 3000);
                return;
            }

            actionMessageEl.textContent = "Sending cargo...";
            actionMessageEl.className = "text-xs text-center mt-3 h-4 text-indigo-600";

            const success = await updateInventoryBatchBackend(updates);

            if (success) {
                actionMessageEl.textContent = `All ${totalBoxesSent} selected boxes sent successfully!`;
                actionMessageEl.className = "text-xs text-center mt-3 h-4 text-green-500";
                await fetchInventory();
                resetSelectedBoxCounts();
                updateAllBoxCountDisplays();
                updateTruckStatusUI();
                cleanup3DScene();
            }
            setTimeout(() => actionMessageEl.textContent = "", 5000);
        }

        // --- Add Boxes Modal Logic ---
        function handleShowAddBoxesModal() {
            addBoxesContainer.innerHTML = ''; // Clear previous content
            Object.keys(BOX_TYPES_DATA).forEach(key => {
                const box = BOX_TYPES_DATA[key];
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md';
                item.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${box.icon} fa-lg w-8 text-center text-purple-500"></i>
                        <span class="ml-3 font-medium">${box.name}</span>
                    </div>
                    <div class="flex items-center justify-center">
                        <button class="add-quantity-btn p-2 bg-gray-200 hover:bg-gray-300 rounded-l-md" data-box-key="${key}" data-change="-1">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="add-count-${key}" value="0" min="0" class="quantity-input w-20" data-box-key="${key}" />
                        <button class="add-quantity-btn p-2 bg-gray-200 hover:bg-gray-300 rounded-r-md" data-box-key="${key}" data-change="1">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;
                addBoxesContainer.appendChild(item);
            });
            addBoxesContainer.addEventListener('click', handleAddModalQuantityClick);
            addBoxesModal.classList.remove('modal-hidden');
        }

        function handleAddModalQuantityClick(event) {
            const button = event.target.closest('.add-quantity-btn');
            if (!button) return;
            const boxKey = button.dataset.boxKey;
            const change = parseInt(button.dataset.change, 10);
            const input = document.getElementById(`add-count-${boxKey}`);
            if (!input) return;
            let newValue = (parseInt(input.value, 10) || 0) + change;
            if (newValue < 0) newValue = 0;
            input.value = newValue;
        }

        async function handleConfirmAddBoxes() {
            let updates = [];
            let totalBoxesAdded = 0;
            const inputs = addBoxesContainer.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                const count = parseInt(input.value, 10);
                if (count > 0) {
                    const boxKey = input.dataset.boxKey;
                    updates.push({ box_key: boxKey, change_amount: count });
                    totalBoxesAdded += count;
                }
            });

            if (totalBoxesAdded === 0) {
                actionMessageEl.textContent = "No boxes specified to add.";
                actionMessageEl.className = "text-xs text-center mt-3 h-4 text-orange-500";
                setTimeout(() => actionMessageEl.textContent = "", 3000);
                addBoxesModal.classList.add('modal-hidden');
                return;
            }

            actionMessageEl.textContent = `Adding ${totalBoxesAdded} boxes to stock...`;
            actionMessageEl.className = "text-xs text-center mt-3 h-4 text-indigo-600";
            addBoxesModal.classList.add('modal-hidden');

            const success = await updateInventoryBatchBackend(updates);

            if (success) {
                actionMessageEl.textContent = `Successfully added ${totalBoxesAdded} boxes!`;
                actionMessageEl.className = "text-xs text-center mt-3 h-4 text-green-500";
                await fetchInventory(); // Refresh all data
                updateAllBoxCountDisplays(); // Update main page UI
                updateTruckStatusUI();
            }
             setTimeout(() => actionMessageEl.textContent = "", 5000);
        }

        // --- 3D Visualization (Original Version) ---
        let scene, camera, renderer, truckMesh, controls, animationFrameId, loadedBoxMeshes = [];

        async function handleView3DLoad() {
            actionMessageEl.textContent = "Calculating optimal placement...";
            actionMessageEl.className = "text-xs text-center mt-3 h-4 text-indigo-600";

            if (!selectedTruckKey) return;

            const truckData = TRUCK_TYPES_DATA[selectedTruckKey];
            const boxesForAPI = {};
            let totalSelectedBoxes = 0;
            Object.keys(selectedBoxCounts).forEach(key => {
                const countToPack = Math.min(selectedBoxCounts[key], INVENTORY_DATA[key] || 0);
                if (countToPack > 0) {
                    boxesForAPI[key] = { ...BOX_TYPES_DATA[key], count: countToPack };
                    totalSelectedBoxes += countToPack;
                }
            });

            if (totalSelectedBoxes === 0) {
                 actionMessageEl.textContent = "No boxes selected or available in stock.";
                 actionMessageEl.className = "text-xs text-center mt-3 h-4 text-orange-500";
                 setTimeout(() => actionMessageEl.textContent = "", 3000);
                 return;
            }

            const payload = { truck: truckData, boxes: boxesForAPI };

            try {
                const response = await fetch('http://127.0.0.1:5500/pack', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();

                selectedBoxCounts = {};
                result.placements.forEach(p => {
                    selectedBoxCounts[p.key] = (selectedBoxCounts[p.key] || 0) + 1;
                });
                updateAllBoxCountDisplays();
                updateTruckStatusUI();

                if (result.unplaced_count > 0) {
                     actionMessageEl.textContent = `Placed ${result.placements.length} boxes. ${result.unplaced_count} could not fit.`;
                     actionMessageEl.className = "text-xs text-center mt-3 h-4 text-orange-500";
                } else {
                     actionMessageEl.textContent = `Success! All ${result.placements.length} selected boxes were placed.`;
                     actionMessageEl.className = "text-xs text-center mt-3 h-4 text-green-500";
                }

                modal3D.classList.remove('modal-hidden');
                setTimeout(() => {
                    initialize3DScene(truckData);
                    renderBoxesInScene(result.placements);
                    animate();
                }, 100);

            } catch (error) {
                console.error('Error calling packing API:', error);
                actionMessageEl.textContent = "Error from packing backend. Is it running?";
                actionMessageEl.className = "text-xs text-center mt-3 h-4 text-red-500";
            } finally {
                 setTimeout(() => actionMessageEl.textContent = "", 5000);
            }
        }

        function initialize3DScene(truckData) {
            cleanup3DScene();
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xeeeeee);
            const containerWidth = sceneContainer.clientWidth;
            const containerHeight = sceneContainer.clientHeight;
            if (containerWidth === 0 || containerHeight === 0) return;

            camera = new THREE.PerspectiveCamera(75, containerWidth / containerHeight, 0.1, 10000);
            camera.position.set(truckData.length * 0.75, truckData.height * 1.5, truckData.width * 1.5);
            camera.lookAt(0, truckData.height / 2, 0);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(containerWidth, containerHeight);
            sceneContainer.innerHTML = ''; // Clear previous content (like 'Loading...')
            sceneContainer.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.target.set(0, truckData.height / 2, 0);
            controls.enableDamping = true;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
            directionalLight.position.set(truckData.length, truckData.height * 2, truckData.width * 1.5);
            scene.add(directionalLight);

            const truckGeometry = new THREE.BoxGeometry(truckData.length, truckData.height, truckData.width);
            const truckEdges = new THREE.EdgesGeometry(truckGeometry);
            const truckMaterial = new THREE.LineBasicMaterial({ color: 0x333333, linewidth: 2 });
            truckMesh = new THREE.LineSegments(truckEdges, truckMaterial);
            truckMesh.position.set(0, truckData.height / 2, 0);
            scene.add(truckMesh);

            const gridHelper = new THREE.GridHelper(Math.max(truckData.length, truckData.width) * 1.5 , 20, 0x888888, 0xcccccc);
            scene.add(gridHelper);
            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            if (!camera || !renderer || !sceneContainer) return;
            const containerWidth = sceneContainer.clientWidth;
            const containerHeight = sceneContainer.clientHeight;
            if (containerWidth === 0 || containerHeight === 0) return;

            camera.aspect = containerWidth / containerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(containerWidth, containerHeight);
        }

        function renderBoxesInScene(placements) {
            if (!scene) return;

            placements.forEach(p => {
                const boxGeo = new THREE.BoxGeometry(p.length, p.height, p.width);
                const boxMat = new THREE.MeshStandardMaterial({
                    color: BOX_TYPES_DATA[p.key]?.color || 0xaaaaaa,
                    transparent: true,
                    opacity: 0.9
                });
                const boxMesh = new THREE.Mesh(boxGeo, boxMat);
                boxMesh.position.set(p.x_center, p.y_center, p.z_center);
                scene.add(boxMesh);
                loadedBoxMeshes.push(boxMesh);

                const edges = new THREE.EdgesGeometry(boxGeo);
                const lineMat = new THREE.LineBasicMaterial({ color: 0x222222, opacity: 0.5, transparent: true });
                const lineSegments = new THREE.LineSegments(edges, lineMat);
                lineSegments.position.copy(boxMesh.position);
                scene.add(lineSegments);
                loadedBoxMeshes.push(lineSegments);
            });
        }

        function animate() {
            if (!renderer || !scene || !camera) {
                if(animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                return;
            }
            animationFrameId = requestAnimationFrame(animate);
            if (controls) controls.update();
            renderer.render(scene, camera);
        }

        function cleanup3DScene() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            if (scene) {
                loadedBoxMeshes.forEach(mesh => {
                    if (mesh.geometry) mesh.geometry.dispose();
                    if (mesh.material) {
                        if(Array.isArray(mesh.material)) mesh.material.forEach(m=>m.dispose());
                        else mesh.material.dispose();
                    }
                    scene.remove(mesh);
                });
                loadedBoxMeshes = [];

                if (truckMesh) {
                    if (truckMesh.geometry) truckMesh.geometry.dispose();
                    if (truckMesh.material) truckMesh.material.dispose();
                    scene.remove(truckMesh);
                    truckMesh = null;
                }
                const gridHelper = scene.getObjectByProperty('type', 'GridHelper');
                if(gridHelper) {
                    scene.remove(gridHelper);
                    if(gridHelper.geometry) gridHelper.geometry.dispose();
                    if(gridHelper.material) gridHelper.material.dispose();
                }
                scene = null;
            }
            if (renderer) {
                renderer.dispose();
                if (renderer.domElement && renderer.domElement.parentElement) {
                    renderer.domElement.parentElement.removeChild(renderer.domElement);
                }
                renderer = null;
            }
            if (controls) {
                controls.dispose();
                controls = null;
            }
            camera = null;
            window.removeEventListener('resize', onWindowResize);
            if(loading3DMessageEl) loading3DMessageEl.classList.add('hidden');
        }

        // --- Start the app ---
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>